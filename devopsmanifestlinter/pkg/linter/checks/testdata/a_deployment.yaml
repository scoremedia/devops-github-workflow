apiVersion: apps/v1
kind: Deployment
metadata:
  name: concierge-core
  namespace: default
  labels:
    helm.sh/chart: concierge-0.1.32
    project: concierge
    app.kubernetes.io/version: "24.2.0"
    app.kubernetes.io/managed-by: Helm
    tags.datadoghq.com/env:  staging
    tags.datadoghq.com/service: concierge
    tags.datadoghq.com/version: 24.2.0
    role: core
spec:
  revisionHistoryLimit: 5
  strategy:
    rollingUpdate:
      maxSurge: 0
      maxUnavailable: 25%
    type: RollingUpdate
  selector:
    matchLabels:
      project: concierge
      role: core

  template:
    metadata:
      name: concierge-core
      labels:
        helm.sh/chart: concierge-0.1.32
        project: concierge
        app.kubernetes.io/version: "24.2.0"
        app.kubernetes.io/managed-by: Helm
        tags.datadoghq.com/env:  staging
        tags.datadoghq.com/service: concierge
        tags.datadoghq.com/version: 24.2.0
        role: core
      annotations:
        vault.hashicorp.com/role: "concierge"
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/agent-init-first: "true"
        vault.hashicorp.com/agent-inject-secret-concierge: "scorebet/data/concierge/staging/ca-default"
        vault.hashicorp.com/agent-inject-template-concierge: |
          {{- with secret "scorebet/data/concierge/staging/ca-default" -}}
             {{- range $k, $v := .Data.data }}
              export {{$k -}}="{{$v -}}"
            {{- end }}
          {{ end }}
    spec:
      serviceAccountName: concierge
      containers:
      - name:  app
        image: "us.gcr.io/thescore-devops/concierge/core:bb03091271e0663cdcb78a8dd041d115a18d59da"
        imagePullPolicy: IfNotPresent
        command:
          - bash
          - -c
          - source /vault/secrets/concierge && ./bin/core start
        ports:
          - containerPort: 4001
            name: http
          - containerPort: 7700
            name: grpc
          - containerPort: 4369
            name: tcp-epmd
        livenessProbe:
          httpGet:
            path: /liveness
            port: 4001
          initialDelaySeconds: 60
          periodSeconds: 15
          timeoutSeconds: 5
          failureThreshold: 3
          
        readinessProbe:
          httpGet:
            path: /readiness
            port: 4001
          initialDelaySeconds: 60
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 2
          
        env:
          - name: KUBERNETES_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          - name: K8S_POD_IP
            valueFrom:
              fieldRef:
                fieldPath: status.podIP
          - name: APP_NAME
            value: core
          - name: DD_AGENT_APM_PORT
            value: "8126"
          - name: DD_ENV
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.labels['tags.datadoghq.com/env']
          - name: DD_SERVICE
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.labels['tags.datadoghq.com/service']
          - name: DD_AGENT_HOST
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: status.hostIP
          - name: DD_ENTITY_ID
            valueFrom:
              fieldRef:
                apiVersion: v1
                fieldPath: metadata.uid
        envFrom:
          - configMapRef:
              name: concierge
        resources:
          limits:
            memory: 2Gi
          requests:
            cpu: "2"
            memory: 1Gi
